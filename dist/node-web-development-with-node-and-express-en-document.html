<h1>Web development with node and express</h1>
<h2>Options and libraries</h2>
<ul>
<li>plain node (createServer)</li>
<li><em>connect</em> (includes middleware)</li>
<li><em>express</em> (includes middleware, routing, view rendering, ...)</li>
</ul>
<p>most projects will use <em>express</em></p>
<h2>Options and libraries</h2>
<p>middleware: via <code>.use()</code></p>
<p>routing: via <code>.get()</code>, <code>.post()</code>, ...</p>
<p><em>Express</em>: Library that supports middleware, routing and templates</p>
<h2>Hosting options</h2>
<ul>
<li>online editors
<ul>
<li>glitch</li>
<li>codepen</li>
</ul>
</li>
</ul>
<h1>Request and response</h1>
<h2>Request and response</h2>
<p>sending the same response to all requests:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// provide a function that handles the request</span>
<span class="hljs-comment">// and sends a response</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.set({ <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span> });
  res.send(<span class="hljs-string">'Hello World\n'</span>);
});

<span class="hljs-comment">// listen on localhost:3000</span>
app.listen(<span class="hljs-number">3000</span>);
</code></pre>
<h2>Request and response</h2>
<p>basic example without <em>express</em> (see <a href="https://nodejs.org/en/docs/guides/getting-started-guide/">https://nodejs.org/en/docs/guides/getting-started-guide/</a>):</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'http'</span>;

<span class="hljs-keyword">const</span> handler = <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.statusCode = <span class="hljs-number">200</span>;
  res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);
  res.end(<span class="hljs-string">'Hello World\n'</span>);
};

<span class="hljs-keyword">const</span> server = http.createServer(handler);
server.listen(<span class="hljs-number">3000</span>);
</code></pre>
<h2>Request and response</h2>
<p>a request handler function receives two arguments:</p>
<ul>
<li><code>req</code> - represents the incoming <em>request</em> (class <a href="https://nodejs.org/api/http.html#http_class_http_incomingmessage">IncomingMessage</a> in node, subclass <a href="http://expressjs.com/en/4x/api.html#req">Request</a> in express)</li>
<li><code>res</code> - respresents the <em>response</em> that will be sent (class <a href="https://nodejs.org/api/http.html#http_class_http_serverresponse">ServerResponse</a> in node, subclass <a href="http://expressjs.com/en/4x/api.html#res">Response</a> in express)</li>
</ul>
<h2>Exercise</h2>
<p>exercise: create a web app that displays the current time as plain text</p>
<h2>Exercise</h2>
<p>solution:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-keyword">const</span> app = express();

app.use(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.set({ <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span> });
  res.send(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString());
});

app.listen(<span class="hljs-number">3000</span>);
</code></pre>
<h1>The request object</h1>
<h2>The request object</h2>
<p>example of a request object:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">"url"</span>: <span class="hljs-string">"/"</span>,
  <span class="hljs-attr">"method"</span>: <span class="hljs-string">"GET"</span>,
  <span class="hljs-attr">"headers"</span>: {
    <span class="hljs-attr">"user-agent"</span>: <span class="hljs-string">"Mozilla/5.0 (Windows ..."</span>
  }
}
</code></pre>
<p>class in plain node / <em>connect</em>: <a href="https://nodejs.org/api/http.html#http_class_http_incomingmessage">IncomingMessage</a></p>
<p>class in <em>express</em>: <a href="https://expressjs.com/de/api.html#req">Request</a></p>
<h2>The request object</h2>
<p>exercise: create a website with different responses based on the requested URL</p>
<h1>The response object</h1>
<h2>The response object</h2>
<p>class in plain node / <em>connect</em>: <a href="https://nodejs.org/api/http.html#http_class_http_serverresponse">ServerResponse</a></p>
<p>class in <em>express</em>: <a href="https://expressjs.com/de/api.html#res">Response</a></p>
<h2>The response object</h2>
<p>methods in express:</p>
<ul>
<li><code>.send()</code></li>
<li><code>.set()</code></li>
<li><code>.status()</code></li>
</ul>
<h2>The response object</h2>
<p>example:</p>
<pre><code class="hljs language-js">res.set({ <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span> });
res.send(<span class="hljs-string">'Date:\n'</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleDateString());
</code></pre>
<h2>The response object</h2>
<pre><code class="hljs language-js">res.status(<span class="hljs-number">404</span>);
res.set({ <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span> });
res.send(<span class="hljs-string">'Document not found.\n'</span>);
</code></pre>
<h2>The response object</h2>
<p>setting a cookie:</p>
<pre><code class="hljs language-js">res.cookie(<span class="hljs-string">'a'</span>, <span class="hljs-string">'1'</span>);
</code></pre>
<p>or explicitly:</p>
<pre><code class="hljs language-js">res.set({ <span class="hljs-string">'Set-Cookie'</span>: <span class="hljs-string">'a=1'</span> });
</code></pre>
<h1>Routing and redirects</h1>
<h2>Routing and redirects</h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-keyword">const</span> app = express();

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.send(<span class="hljs-string">'Hello World!\n'</span>);
});
app.get(<span class="hljs-string">'/about'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.send(<span class="hljs-string">'About page\n'</span>);
});
app.get(<span class="hljs-string">'/articles/:id'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  <span class="hljs-keyword">const</span> articleId = req.params.id;
  <span class="hljs-comment">// ...</span>
});
app.get(<span class="hljs-string">'/home'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.redirect(<span class="hljs-string">'/'</span>);
});

app.listen(<span class="hljs-number">3000</span>);
</code></pre>
<h1>Rendering HTML</h1>
<h2>Rendering HTML</h2>
<p>manually:</p>
<pre><code class="hljs language-js">app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.send(<span class="hljs-string">`
    &#x3C;!DOCTYPE html>
    &#x3C;html>
      &#x3C;head>&#x3C;title>Hello world&#x3C;/title>&#x3C;/head>
      &#x3C;body>Hello world&#x3C;/body>
    &#x3C;/html>
  `</span>);
});
</code></pre>
<h2>Rendering HTML</h2>
<p>via a template engine:</p>
<ul>
<li>ejs: <a href="https://ejs.co/">website</a>, <a href="https://github.com/mde/ejs/wiki/Using-EJS-with-Express">express integration</a></li>
<li>handlebars (or mustache): <a href="https://handlebarsjs.com/">website</a>, <a href="https://github.com/express-handlebars/express-handlebars">express integration</a></li>
<li>pug: <a href="https://pugjs.org">website</a>, <a href="https://expressjs.com/en/guide/using-template-engines.html">express integration</a></li>
<li>react: <a href="https://reactjs.org/">website</a>, <a href="https://github.com/reactjs/express-react-views">express integration</a></li>
<li>... (<a href="https://expressjs.com/en/resources/template-engines.html">list of options</a>)</li>
</ul>
<h2>Rendering HTML via EJS</h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> ejs <span class="hljs-keyword">from</span> <span class="hljs-string">'ejs'</span>;

<span class="hljs-keyword">const</span> app = express();

app.set(<span class="hljs-string">'view engine'</span>, ejs);

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  <span class="hljs-comment">// renders 'views/home.ejs'</span>
  res.render(<span class="hljs-string">'home'</span>);
});

<span class="hljs-comment">// ...</span>
</code></pre>
<h2>Rendering HTML via express-handlebars</h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> expressHandlebars <span class="hljs-keyword">from</span> <span class="hljs-string">'express-handlebars'</span>;

<span class="hljs-keyword">const</span> app = express();

app.engine(<span class="hljs-string">'handlebars'</span>, expressHandlebars());
app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'handlebars'</span>);

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  <span class="hljs-comment">// renders 'views/home.handlebars'</span>
  res.render(<span class="hljs-string">'home'</span>);
});
</code></pre>
<h2>Rendering HTML via express-react-views</h2>
<p>install npm packages: <em>express-react-views</em>, <em>react</em>, <em>react-dom</em></p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> expressReactViews <span class="hljs-keyword">from</span> <span class="hljs-string">'express-react-views'</span>;

<span class="hljs-keyword">const</span> app = express();

app.engine(<span class="hljs-string">'jsx'</span>, expressReactViews.createEngine());
app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'jsx'</span>);

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  <span class="hljs-comment">// renders 'views/home.jsx' with one property</span>
  res.render(<span class="hljs-string">'home'</span>, { <span class="hljs-attr">foo</span>: <span class="hljs-string">'bar'</span> });
});
</code></pre>
<h2>Rendering HTML via express-react-views</h2>
<p><em>views/home.jsx</em>:</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> Home = <span class="hljs-function">() =></span> {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">html</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">head</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">title</span>></span>Home<span class="hljs-tag">&#x3C;/<span class="hljs-name">title</span>></span>
      <span class="hljs-tag">&#x3C;/<span class="hljs-name">head</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">body</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>Home<span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span>
      <span class="hljs-tag">&#x3C;/<span class="hljs-name">body</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">html</span>></span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Home;
</code></pre>
<h2>Exercises</h2>
<p>exercises:</p>
<ul>
<li>create a website with different pages (<em>home</em>, <em>about</em>, <em>newsletter</em>, ...)</li>
<li>create a website that displays information from a public API (e.g. <a href="https://pokeapi.co/">https://pokeapi.co/</a>)</li>
</ul>
<h2>Exercise: Pokeapi</h2>
<p>part 1:</p>
<pre><code class="hljs language-jsx">app.get(<span class="hljs-string">'/:id'</span>, <span class="hljs-keyword">async</span> (req, res) => {
  <span class="hljs-keyword">const</span> id = req.params.id;
  <span class="hljs-keyword">const</span> dataRes = <span class="hljs-keyword">await</span> fetch(
    <span class="hljs-string">`https://pokeapi.co/api/v2/pokemon/<span class="hljs-subst">${id}</span>`</span>
  );
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> dataRes.json();
  <span class="hljs-keyword">await</span> res.render(<span class="hljs-string">'pokemon'</span>, { <span class="hljs-attr">id</span>: id, <span class="hljs-attr">data</span>: data });
});
app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.redirect(<span class="hljs-string">'/1'</span>);
});
</code></pre>
<h2>Exercise: Pokeapi</h2>
<p>part 2:</p>
<pre><code class="hljs language-jsx"><span class="hljs-comment">// views/pokemon.jsx</span>
<span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> Pokemon = <span class="hljs-function">(<span class="hljs-params">props</span>) =></span> {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">Number</span>(props.id);
  <span class="hljs-keyword">const</span> data = props.data;
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">article</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">h1</span>></span>{data.species.name}<span class="hljs-tag">&#x3C;/<span class="hljs-name">h1</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{data.sprites.front_default}</span> /></span>
      <span class="hljs-tag">&#x3C;/<span class="hljs-name">article</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/${<span class="hljs-attr">id</span> <span class="hljs-attr">-</span> <span class="hljs-attr">1</span>}`}></span>prev<span class="hljs-tag">&#x3C;/<span class="hljs-name">a</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">br</span> /></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/${<span class="hljs-attr">id</span> + <span class="hljs-attr">1</span>}`}></span>next<span class="hljs-tag">&#x3C;/<span class="hljs-name">a</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Pokemon;
</code></pre>
<h1>Middleware</h1>
<h2>Middleware</h2>
<p><em>middleware</em> is available in <em>connect</em> and in <em>express</em></p>
<h2>Middleware</h2>
<p><a href="https://expressjs.com/en/resources/middleware.html">list of available express middleware</a></p>
<h2>Middleware</h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-comment">// app is a request handler that can be extended</span>
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// parse urlencoded request bodies into req.body</span>
app.use(express.urlencoded());
<span class="hljs-comment">// parse JSON request bodies into req.body</span>
app.use(express.json());

<span class="hljs-comment">// respond to all requests</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.set({ <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span> });
  res.end(<span class="hljs-string">'Hello World!\n'</span>);
});

app.listen(<span class="hljs-number">3000</span>);
</code></pre>
<h1>JSON data</h1>
<h2>JSON data</h2>
<p>sending JSON (manually):</p>
<pre><code class="hljs language-js">res.setHeader({<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>});
res.send(<span class="hljs-built_in">JSON</span>.stringify(data));
</code></pre>
<p>with the <code>.json()</code> helper:</p>
<pre><code class="hljs language-js">res.json(data);
</code></pre>
<h2>JSON data</h2>
<p>receiving (parsing) JSON via middleware:</p>
<pre><code class="hljs language-js">app.use(express.json());
</code></pre>
<p>data will be available as <code>req.body</code></p>
<h1>API development</h1>
<h2>API development</h2>
<p>topics:</p>
<ul>
<li>Same-origin policy and Cross-origin resource sharing</li>
<li>JSON-RPC</li>
<li>REST</li>
<li>GraphQL</li>
</ul>
<h1>Same-origin policy and CORS</h1>
<h2>Same-origin policy</h2>
<p>by default, a webpage served from one site (e.g. <em><a href="http://www.example.com">www.example.com</a></em>) is not allowed to make requests to another site (e.g. <em>api.example.com</em>) from within the browser (<em>Same-origin policy</em>)</p>
<h2>Same-origin policy</h2>
<p>example: go to one website (e.g. Wikipedia), open the browser's JavaScript console and request another website, e.g. via <code>fetch("https://google.com")</code></p>
<p>result: the request is prohibited</p>
<h2>Same-origin policy</h2>
<p>why: prevent exploitation of cookie-based authentication</p>
<p>scenario:</p>
<p>user visits <em>google.com</em>, logs in, receives an authentication cookie</p>
<p>without logging out, the user visits <em>example.com</em>; <em>example.com</em> cannot make any authenticated requests to <em>google.com</em> and cannot see any of the user's data</p>
<h2>Cross-Origin resource sharing</h2>
<p>The requested site may allow <em>Cross-Origin resource sharing (CORS)</em> for some URLs or for all URLs</p>
<p>example: the <em>jsonplaceholder</em> API enables CORS for all sites - so <code>fetch("https://jsonplaceholder.typicode.com/todos")</code> works from any site</p>
<h2>Cross-Origin resource sharing</h2>
<p>example (request from <em><a href="http://www.example.com">www.example.com</a></em> to <em>api.example.com</em>):</p>
<p>browser sends a request with an extra <code>Origin</code> header:</p>
<pre><code class="hljs language-groovy"><span class="hljs-attr">Origin:</span> <span class="hljs-attr">https:</span><span class="hljs-comment">//www.example.com</span>
</code></pre>
<p>server responds with data and a header indicating why the response was allowed:</p>
<pre><code class="hljs language-groovy">Access-Control-Allow-<span class="hljs-attr">Origin:</span> <span class="hljs-attr">http:</span><span class="hljs-comment">//www.example.com</span>
</code></pre>
<p>or</p>
<pre><code class="hljs language-ada"><span class="hljs-keyword">Access</span>-Control-Allow-Origin: *
</code></pre>
<h1>Same-origin policy and CORS with node</h1>
<h2>Same-origin policy and CORS with node</h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">'cors'</span>;
</code></pre>
<p>allowing requests from all domains:</p>
<pre><code class="hljs language-js">app.use(cors());
</code></pre>
<p>allowing requests from a specific domain:</p>
<pre><code class="hljs language-js">app.use(cors({ <span class="hljs-attr">origin</span>: <span class="hljs-string">'https://www.example.com'</span> }));
</code></pre>
<h1>JSON-RPC</h1>
<h2>JSON-RPC</h2>
<p>example request body:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-attr">"method"</span>: <span class="hljs-string">"pokemon_by_name"</span>,
  <span class="hljs-attr">"params"</span>: { <span class="hljs-attr">"name"</span>: <span class="hljs-string">"pikachu"</span> },
  <span class="hljs-attr">"id"</span>: <span class="hljs-number">1234</span>
}
</code></pre>
<p>example response:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">"error"</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">"result"</span>: { <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Pikachu"</span>, <span class="hljs-attr">"img"</span>: <span class="hljs-string">"..."</span> },
  <span class="hljs-attr">"id"</span>: <span class="hljs-number">1234</span>
}
</code></pre>
<h2>JSON-RPC</h2>
<p>exercise: create a JSON-RPC API that supports the queries <code>pokemon_by_name</code> and <code>type_by_id</code> and queries <a href="https://pokeapi.co/api">https://pokeapi.co/api</a> in the background</p>
<h1>REST</h1>
<h2>REST</h2>
<p>see <a href="https://www.robinwieruch.de/node-express-server-rest-api">https://www.robinwieruch.de/node-express-server-rest-api</a></p>