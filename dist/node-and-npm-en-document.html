<h1>Node and npm</h1>
<h1>Node and npm: overview</h1>
<h2>Node and npm: overview</h2>
<p>Node.js is a JavaScript runtime</p>
<p>It may be used to:</p>
<ul>
<li>run scripts locally</li>
<li>provide development tools (e.g. for build process, unit tests, ...)</li>
<li>run a backend</li>
</ul>
<h2>Node and npm: overview</h2>
<p><em>npm</em> = <em>Node package manager</em></p>
<p>is included in the node.js installation</p>
<h2>Installation</h2>
<p>Download from <a href="https://nodejs.org">https://nodejs.org</a></p>
<p>Major releases every 6 months; long-term-support releases every 12 months</p>
<h1>npm</h1>
<h2>npm registry</h2>
<p>The npm registry is an online registry consisting primarily of open source JavaScript packages</p>
<p>by far the largest software registry (<a href="http://www.modulecounts.com/">over 1 million packages</a>)</p>
<p>examples: <a href="https://www.npmjs.com/browse/depended">most depended upon packages</a></p>
<h2>Package managers</h2>
<p>two major package managers for the npm registry:</p>
<ul>
<li><em>npm</em>: Node package manager, comes with node.js</li>
<li><em>yarn</em>: may be installed separately</li>
</ul>
<h2>Package configuration</h2>
<p>Both public packages and private projects are managed via a configuration file named <em>package.json</em></p>
<h2>Package configuration</h2>
<p>In order to add dependencies - start out with an empty <em>package.json</em> configuration:</p>
<pre><code class="hljs language-json">{}
</code></pre>
<p>Alternative: create a <em>package.json</em> with some content via via <code>npm init</code> (or <code>npm init -y</code> for default options)</p>
<h2>Adding dependencies</h2>
<p>Add dependencies via e.g.:</p>
<pre><code class="hljs language-bash">npm install lodash bootstrap
</code></pre>
<h2>Adding dependencies</h2>
<p>When developing a reusable library to be published on the npm package registry:</p>
<p>Install dependencies that are only needed for development as <em>dev-dependencies</em>:</p>
<pre><code class="hljs language-bash">npm install eslint --save-dev
</code></pre>
<h2>Adding dependencies</h2>
<p>Effects of the previous <code>npm install</code> commands:</p>
<ul>
<li><code>package.json</code> - lists minimum versions of the packages we just installed</li>
<li><code>node_modules</code> - folder that contains all installed packages</li>
<li><code>package-lock.json</code> - lists exact versions of all packages in <code>node_modules</code></li>
</ul>
<h2>Dependencies in package.json</h2>
<p>The file <code>package.json</code> now lists dependencies together with a version specifier</p>
<p>The version specifier uses <em>semantic versioning</em>: <code>major.minor.patch</code></p>
<p>possible configurations:</p>
<ul>
<li><code>"bootstrap": "4.3.1"</code> - exactly this version</li>
<li><code>"bootstrap": "~4.3.1"</code> - patch version updates allowed - for example to <code>4.3.2</code></li>
<li><code>"bootstrap": "^4.3.1"</code> - minor version updates allowed - for example to <code>4.4.0</code></li>
</ul>
<h2>Dependencies in package-lock.json</h2>
<p><code>package-lock.json</code> lists <em>exact</em> versions for all dependencies and their recursive dependencies</p>
<h2>node_modules folder</h2>
<p>contains the actual packages</p>
<p>this should not be put under version control - can be recreated from <code>package.json</code> by running <code>npm install</code> (without any arguments)</p>
<h2>npm scripts</h2>
<p>Npm can be used to execute scripts / commands that are needed for development, for example:</p>
<ul>
<li><code>npm run test</code> - would run unit tests</li>
<li><code>npm run build</code> - would create a build</li>
<li><code>npm run start</code></li>
<li><code>npm run deploy</code></li>
</ul>
<p>Some npm scripts have shorthands, notably <code>npm test</code> and <code>npm start</code></p>
<h2>npm scripts</h2>
<p>Npm scripts are configured in <code>package.json</code>:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">"scripts"</span>: { <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node run-server.js"</span> }
}
</code></pre>
<h2>Global installs and npx</h2>
<p>Node packages may be installed globally on a computer or may be executed directly from the npm registry</p>
<p>direct execution (without installation):</p>
<pre><code class="hljs language-bash">npx cowsay hello
</code></pre>
<p>global installation of <code>cowsay</code>:</p>
<pre><code class="hljs language-bash">npm install -g cowsay

cowsay hello
</code></pre>
<h1>Running node programs</h1>
<h2>Running programs in the terminal</h2>
<p>hello.js:</p>
<pre><code class="hljs language-js"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Hello world!'</span>);
</code></pre>
<pre><code class="hljs language-bash">node hello.js
</code></pre>
<h2>Running programs in VS Code</h2>
<p>with debugging: <em>F5</em></p>
<p>without debugging: <em>Ctrl</em> + <em>F5</em></p>
<h2>Running programs in VS Code</h2>
<p>to determine how a JavaScript file should be run:</p>
<p>with a JavaScript file open, open the "Run" sidebar</p>
<p>select <em>create a launch.json file</em> - <em>Node.js</em> to create a file under <em>.vscode/launch.json</em></p>
<h2>Running programs in VS Code</h2>
<p>possible configuration entries (<em>.vscode/launch.json</em>):</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Run current file"</span>,
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-attr">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-attr">"program"</span>: <span class="hljs-string">"${file}"</span>,
  <span class="hljs-attr">"skipFiles"</span>: [<span class="hljs-string">"&#x3C;node_internals>/**"</span>]
}
</code></pre>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Run index.js"</span>,
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-attr">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-attr">"program"</span>: <span class="hljs-string">"${workspaceFolder}/index.js"</span>,
  <span class="hljs-attr">"skipFiles"</span>: [<span class="hljs-string">"&#x3C;node_internals>/**"</span>]
}
</code></pre>
<h1>Modules</h1>
<h2>Modules</h2>
<p>Node programs can import objects from so-called modules</p>
<p>3 categories:</p>
<ul>
<li>built-in modules</li>
<li>modules from npm</li>
<li>modules in the local directory</li>
</ul>
<h2>Importing modules</h2>
<p>in newer versions:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;

<span class="hljs-keyword">const</span> currentDirectoryContent = fs.readdirSync(<span class="hljs-string">'.'</span>);
<span class="hljs-built_in">console</span>.log(currentDirectoryContent);
</code></pre>
<p>older syntax:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-keyword">const</span> currentDirectoryContent = fs.readdirSync(<span class="hljs-string">'.'</span>);
<span class="hljs-built_in">console</span>.log(currentDirectoryContent);
</code></pre>
<h2>Importing modules</h2>
<p>to use the more modern syntax in a node project, declare it as a module in <code>package.json</code> (needs node ≥ 13):</p>
<pre><code class="hljs language-json"><span class="hljs-string">"type"</span>: <span class="hljs-string">"module"</span>
</code></pre>
<h2>Importing modules</h2>
<p>to switch to the more modern syntax inside of individual JavaScript files, change their file endings to <code>.mjs</code> (needs node ≥ 13)</p>
<h2>Importing modules</h2>
<p>task: write a node script that uses imports via the old syntax, then switch to the new syntax</p>
<h1>Local modules</h1>
<h2>Local modules</h2>
<p>A JavaScript file that exports objects is called a module</p>
<h2>Local modules</h2>
<p>example of a module with modern syntax:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> message1 = <span class="hljs-string">'hello!'</span>;
<span class="hljs-keyword">const</span> message2 = <span class="hljs-string">'have a nice day!'</span>;

<span class="hljs-keyword">export</span> { message1, message2 };
</code></pre>
<h2>Local modules</h2>
<p>there may be one default export</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> mainMessage = <span class="hljs-string">'xyz'</span>;

<span class="hljs-keyword">const</span> message1 = <span class="hljs-string">'hello!'</span>;
<span class="hljs-keyword">const</span> message2 = <span class="hljs-string">'have a nice day!'</span>;

<span class="hljs-keyword">export</span> { message1, message2 };
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> mainMessage;
</code></pre>
<h2>Local modules</h2>
<p>local modules are referenced via relative file paths:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> mainMessage, { message1 } <span class="hljs-keyword">from</span> <span class="hljs-string">'./messages.js'</span>;
</code></pre>
<p>the filename extension is optional:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> mainMessage, { message1 } <span class="hljs-keyword">from</span> <span class="hljs-string">'./messages'</span>;
</code></pre>
<h2>Local modules</h2>
<p>older export syntax:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> message1 = <span class="hljs-string">'hello!'</span>;
<span class="hljs-keyword">const</span> message2 = <span class="hljs-string">'have a nice day!'</span>;

<span class="hljs-built_in">module</span>.exports.message1 = message1;
<span class="hljs-built_in">module</span>.exports.message2 = message2;
<span class="hljs-comment">// shorthand</span>
<span class="hljs-built_in">exports</span>.message3 = <span class="hljs-string">'Bye'</span>;
</code></pre>
<p>default export:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> mainMessage = <span class="hljs-string">'xyz'</span>;

<span class="hljs-built_in">module</span>.exports = mainMessage;
</code></pre>
<h1>Globals and built-in modules</h1>
<h2>Globals</h2>
<p>different globals than in the browser</p>
<h2>Globals</h2>
<p>browser-only globals:</p>
<ul>
<li><code>window</code> (global namespace) - alternative name <code>globalThis</code></li>
<li><code>fetch</code></li>
<li><code>localStorage</code>, <code>sessionStorage</code></li>
</ul>
<p>node-only globals:</p>
<ul>
<li><code>global</code> (global namespace) - alternative name <code>globalThis</code></li>
<li><code>process</code> (e.g. <code>process.argv</code>)</li>
<li><code>__filename</code> and <code>__dirname</code></li>
</ul>
<h2>Built-in modules</h2>
<ul>
<li>assert</li>
<li>fs (file system)</li>
<li>http(s)</li>
<li>net (TCP)</li>
<li>os</li>
<li>path</li>
<li>...</li>
</ul>
<h1>Process</h1>
<h2>Process</h2>
<p><code>process</code> is a global</p>
<ul>
<li><code>process.argv</code> (command line arguments)</li>
<li><code>process.cwd()</code></li>
<li><code>process.exit()</code></li>
<li>... (see <a href="https://nodejs.org/dist/latest-v15.x/docs/api/process.html">https://nodejs.org/dist/latest-v15.x/docs/api/process.html</a>)</li>
</ul>
<h2>Process</h2>
<p>exercise: implement a program that can be run like this:</p>
<pre><code class="hljs language-bash">node sum.js 1 2 3

the sum is 6
</code></pre>
<h1>Reading and writing files</h1>
<h2>Reading and writing files</h2>
<p>Via the <em>fs</em> module:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;
</code></pre>
<h2>Writing text files</h2>
<pre><code class="hljs language-js">fs.writeFileSync(<span class="hljs-string">'message.txt'</span>, <span class="hljs-string">'hello world'</span>);
</code></pre>
<p>This will write to a text file in UTF-8 encoding.</p>
<h2>Reading text files</h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> fileContent = fs.readFileSync(<span class="hljs-string">'package.json'</span>, <span class="hljs-string">'utf8'</span>);
</code></pre>
<p>When reading text files, we <em>must</em> specify an encoding (in this case, UTF-8)</p>
<h2>Reading files as binary</h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> myFile = fs.readFileSync(<span class="hljs-string">'./package.json'</span>);
</code></pre>
<p>This will return a buffer (a sequence of bytes)</p>
<p>converting a buffer into a string:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> fileTextContent = myFile.toString(<span class="hljs-string">'utf-8'</span>);
</code></pre>
<h2>Asynchronous I/O</h2>
<p>Reading a file will take (relatively) long. With the previous code node cannot execute any code during that time.</p>
<h2>Asynchronous I/O with promises</h2>
<pre><code class="hljs language-js">fs.promises
  .readFile(<span class="hljs-string">'read-file.js'</span>, <span class="hljs-string">'utf8'</span>)
  .then(<span class="hljs-built_in">console</span>.log)
  .catch(<span class="hljs-function">() =></span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error while reading file'</span>);
  });
</code></pre>
<h2>Asynchronous I/O with async / await</h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> readFileAsync = <span class="hljs-keyword">async</span> () => {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> fileContent = <span class="hljs-keyword">await</span> fs.promises.readFile(
      <span class="hljs-string">'read-file.js'</span>,
      <span class="hljs-string">'utf8'</span>
    );
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error while reading file'</span>);
  }
  <span class="hljs-built_in">console</span>.log(fileContent);
};

readFileAsync();
</code></pre>
<h2>Exercises</h2>
<p>create a series of HTML form letters for different recipients from a template</p>
<p>list all files of a specific type (see exercise from learnyounode)</p>
<h1>HTTP client</h1>
<h2>Retrieving a website</h2>
<p>Low-level functionality (separate TCP packages)</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'http'</span>;

http.get(<span class="hljs-string">'http://www.google.com'</span>, <span class="hljs-function">(<span class="hljs-params">responseStream</span>) =></span> {
  responseStream.setEncoding(<span class="hljs-string">'latin1'</span>);
  responseStream.on(<span class="hljs-string">'data'</span>, <span class="hljs-built_in">console</span>.log);
  responseStream.on(<span class="hljs-string">'error'</span>, <span class="hljs-built_in">console</span>.error);
});
</code></pre>
<h2>Exercise</h2>
<p>exercise: retrieve the Google website and save chunks to a JSON array</p>
<h2>Libraries</h2>
<p>libraries for HTTP calls:</p>
<ul>
<li>fetch libraries (<em>node-fetch</em>, <em>isomorphic-fetch</em>)</li>
<li>axios</li>
</ul>
<h2>Node-fetch</h2>
<pre><code class="hljs language-bash">npm install node-fetch
</code></pre>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> fetch <span class="hljs-keyword">from</span> <span class="hljs-string">'node-fetch'</span>;

fetch(<span class="hljs-string">'https://google.com'</span>)
  .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =></span> res.text())
  .then(<span class="hljs-function">(<span class="hljs-params">content</span>) =></span> <span class="hljs-built_in">console</span>.log(content));
</code></pre>
<h2>Exercises</h2>
<ul>
<li>retrieve multiple websites (see learnyounode: juggling async)</li>
<li>number of Google search results for some specific topic</li>
</ul>
<h1>HTTP server with node</h1>
<h2>Running an HTTP server with node</h2>
<p>see <a href="https://nodejs.org/en/docs/guides/getting-started-guide/">https://nodejs.org/en/docs/guides/getting-started-guide/</a></p>
<h2>Running an HTTP server with node</h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'http'</span>;

<span class="hljs-keyword">const</span> hostname = <span class="hljs-string">'127.0.0.1'</span>;
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;

<span class="hljs-keyword">const</span> requestHandler = <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  res.statusCode = <span class="hljs-number">200</span>;
  res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);
  res.end(<span class="hljs-string">'Hello World\n'</span>);
};

server = http.createServer(requestHandler);

server.listen(port, hostname);
</code></pre>
<h2>HTTP server frameworks</h2>
<ul>
<li>connect: middleware</li>
<li>express: middleware, routing</li>
</ul>
<h1>Creating command-line tools</h1>
<h2>Creating command-line tools</h2>
<p>npm package for creating command-line tools: <em>prompt</em></p>
<h2>Creating command-line tools</h2>
<p>example:</p>
<p>when we run <code>node ./hello.js</code> we want this interaction:</p>
<pre><code class="hljs language-txt">prompt: first name: Marko
prompt: birth year: 1988
Hi, Marko!
In the year 2030 you'll be 42!
</code></pre>
<h2>Creating command-line tools</h2>
<p>simple use:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> prompt <span class="hljs-keyword">from</span> <span class="hljs-string">'prompt'</span>;

<span class="hljs-keyword">const</span> main = <span class="hljs-keyword">async</span> () => {
  prompt.start();
  <span class="hljs-keyword">const</span> person = <span class="hljs-keyword">await</span> prompt.get([
    <span class="hljs-string">'first name'</span>,
    <span class="hljs-string">'birth year'</span>,
  ]);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Hi, <span class="hljs-subst">${person[<span class="hljs-string">'first name'</span>]}</span>!`</span>);
  <span class="hljs-keyword">const</span> birthYear = <span class="hljs-built_in">Number</span>(person[<span class="hljs-string">'birth year'</span>]);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`In 2030 you'll be <span class="hljs-subst">${<span class="hljs-number">2030</span> - birthYear}</span>!`</span>);
};
main();
</code></pre>
<h2>Creating command-line tools</h2>
<p>advanced use with validation:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> main = <span class="hljs-keyword">async</span> () => {
  prompt.start();
  <span class="hljs-keyword">const</span> person = <span class="hljs-keyword">await</span> prompt.get({
    <span class="hljs-attr">properties</span>: {
      <span class="hljs-string">'first name'</span>: {},
      <span class="hljs-string">'birth year'</span>: {
        <span class="hljs-attr">description</span>: <span class="hljs-string">'year when you were born'</span>,
        <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/^\d{4}$/</span>,
      },
    },
  });
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Hi, <span class="hljs-subst">${person[<span class="hljs-string">'first name'</span>]}</span>!`</span>);
  <span class="hljs-keyword">const</span> birthYear = <span class="hljs-built_in">Number</span>(person[<span class="hljs-string">'birth year'</span>]);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`In 2030 you'll be <span class="hljs-subst">${<span class="hljs-number">2030</span> - birthYear}</span>!`</span>);
};
</code></pre>
<h1>Publishing npm packages</h1>
<h2>Publishing npm packages</h2>
<ul>
<li>create an account on <em>npmjs.com</em></li>
<li>create a package.json file</li>
<li>create a <em>.gitignore</em> or <em>.npmignore</em> file</li>
<li>run <code>npm publish --access public</code></li>
</ul>
<h2>package.json - basic entries</h2>
<ul>
<li><em>name</em>: either <em>mypackage</em> (if still available) or <em>@myusername/mypackage</em></li>
<li><em>description</em></li>
<li><em>version</em>: e.g. <em>0.1.0</em></li>
<li><em>author</em>: author's name</li>
<li><em>license</em>: e.g. <em>UNLICENSED</em>, <em>ISC</em>, <em>GPL-3.0</em>, ...</li>
</ul>
<h2>package.json - advanced entries</h2>
<ul>
<li><em>main</em>: e.g. <em>index.js</em> - the entry point when importing this package</li>
<li><em>scripts</em>: commands that can be run via <em>npm run</em> (e.g. <em>build</em>, <em>test</em>, <em>start</em>, ...)</li>
<li><em>bin</em>: commands that can be run from the command line or via npx</li>
<li><em>dependencies</em>: npm packages that are required to use this npm package</li>
<li><em>devDependencies</em>: npm packages that are required to develop this npm package (e.g. test tools, build tools)</li>
</ul>
<h2>package.json entries</h2>
<p>See <a href="https://docs.npmjs.com/files/package.json">https://docs.npmjs.com/files/package.json</a></p>
<h2>Ignoring files</h2>
<p>Create a <code>.gitignore</code> or <code>.npmignore</code> file that lists files that shouldn't be published:</p>
<pre><code class="hljs language-css"><span class="hljs-selector-class">.git</span>
<span class="hljs-selector-tag">node_modules</span>
<span class="hljs-selector-tag">package-lock</span><span class="hljs-selector-class">.json</span>
</code></pre>
<h2>Publishing</h2>
<pre><code class="hljs language-bash">npm publish --access public
</code></pre>
<h2>npx scripts</h2>
<p>entry "bin" in <code>package.json</code> (should match package name without username):</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"@user/foo-package"</span>,
  <span class="hljs-attr">"bin"</span>: {
    <span class="hljs-attr">"foo-package"</span>: <span class="hljs-string">"./foo-bin.js"</span>
  }
}
</code></pre>
<p>contents of <code>foo-bin.js</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-meta">#! /usr/bin/env node</span>

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'this is the npx script of foo-package'</span>);
</code></pre>
<h1>Resources</h1>
<h2>Resources</h2>
<ul>
<li><a href="https://medium.freecodecamp.org/the-definitive-node-js-handbook-6912378afc6e">The definitive Node.js handbook by Flavio Copes</a></li>
<li><a href="https://glitch.com">Node.js web playground on glitch.com</a></li>
</ul>